name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: release
    permissions: {}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Compute source tarball sha256
        id: sha
        run: |
          URL="https://github.com/wildreason/reader/archive/refs/tags/${{ steps.version.outputs.tag }}.tar.gz"
          curl -sfL "$URL" -o /tmp/source.tar.gz
          SHA256=$(sha256sum /tmp/source.tar.gz | cut -d ' ' -f 1)
          if [ ${#SHA256} -ne 64 ]; then echo "sha256 validation failed"; exit 1; fi
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Update homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          git clone "https://github.com/wildreason/homebrew-tap.git" tap
          cd tap
          git remote set-url origin "https://x-access-token:${TAP_TOKEN}@github.com/wildreason/homebrew-tap.git"
          if [ -d Casks ]; then git rm -rf Casks; fi
          mkdir -p Formula
          cat > Formula/aster.rb << FORMULA
          class Aster < Formula
            desc "Terminal file reader. Markdown, JSONL, diffs, and more."
            homepage "https://github.com/wildreason/reader"
            url "https://github.com/wildreason/reader/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "go" => :build

            def install
              ldflags = %W[
                -s -w
                -X main.Version=#{version}
                -X main.Commit=brew
                -X main.Date=#{time.iso8601}
              ]
              system "go", "build", *std_go_args(ldflags:)
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/aster --version")
            end
          end
          FORMULA
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "aster ${TAG}"
            git push origin main
          fi
